ä¸‹é¢æˆ‘ç»™ä½  **æœ€æ¸…æ™°ã€æœ€å®æˆ˜** çš„ Express æ–‡ä»¶ä¸Šä¼ æ•™ç¨‹ï¼ŒåŒ…æ‹¬ï¼š

# â­ ä½ ä¼šå­¦åˆ°

* å¦‚ä½•å®ç° **æ–‡ä»¶ä¸Šä¼ **
* å¦‚ä½•å®ç° **å›¾ç‰‡ä¸Šä¼  + é¢„è§ˆ + ä¿å­˜è·¯å¾„**
* å¦‚ä½•å®ç° **å¤šæ–‡ä»¶ä¸Šä¼ **
* å¦‚ä½•å®ç° **é™åˆ¶æ–‡ä»¶ç±»å‹ï¼ˆåªå…è®¸å›¾ç‰‡ï¼‰**
* å¦‚ä½•å®ç° **é™åˆ¶æ–‡ä»¶å¤§å°**
* å®Œæ•´å¯ç”¨çš„æ¡ˆä¾‹ä»£ç 

è¿™äº›éƒ½æ˜¯ä½ æœªæ¥ Node.js é¡¹ç›®é‡Œæœ€å¸¸ç”¨çš„çŸ¥è¯†ç‚¹ã€‚

---

# ğŸŸ¦ ä¸€ã€æ–‡ä»¶ä¸Šä¼ å¿…é¡»ä½¿ç”¨çš„ä¸­é—´ä»¶ï¼š`multer`

```bash
npm install multer
```

---

# ğŸŸ¦ äºŒã€æœ€åŸºæœ¬çš„æ–‡ä»¶ä¸Šä¼ ï¼ˆä»»ä½•æ–‡ä»¶éƒ½å¯ä»¥ä¸Šä¼ ï¼‰

## âœ” æœ€ç®€å•çš„ Express ä¸Šä¼ ä»£ç ï¼ˆå•æ–‡ä»¶ï¼‰

```js
const express = require('express');
const multer = require('multer');
const path = require('path');

const app = express();

// è®¾ç½®ä¸Šä¼ ç›®å½•
const upload = multer({ dest: 'uploads/' });

app.post('/upload', upload.single('file'), (req, res) => {
  console.log(req.file); // æ–‡ä»¶ä¿¡æ¯
  res.send('ä¸Šä¼ æˆåŠŸ');
});

app.listen(3000, () => console.log("Server running at 3000"));
```

## ğŸ” HTML å‰ç«¯ä¸Šä¼ ç¤ºä¾‹

ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª upload.htmlï¼š

```html
<form action="/upload" method="POST" enctype="multipart/form-data">
  <input type="file" name="file" />
  <button type="submit">ä¸Šä¼ </button>
</form>
```

---

# ğŸŸ¦ ä¸‰ã€å›¾ç‰‡ä¸Šä¼ ï¼ˆå¸¦æ–‡ä»¶åã€è·¯å¾„ã€æ ¼å¼ï¼‰

æˆ‘ä»¬è¦è®©å›¾ç‰‡ä¸Šä¼ åï¼š

âœ” å­˜åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
âœ” è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶å
âœ” é™åˆ¶æ–‡ä»¶ç±»å‹
âœ” è¿”å›å›¾ç‰‡ URL åœ°å€ï¼ˆå¯å±•ç¤ºï¼‰

---

# â­ å››ã€å›¾ç‰‡ä¸Šä¼ é«˜çº§ç‰ˆï¼ˆæ¨èé¡¹ç›®ä½¿ç”¨ï¼‰

## 1) é…ç½®æ–‡ä»¶å­˜å‚¨æ¨¡å¼ï¼ˆé‡è¦ï¼‰

ä½¿ç”¨ `multer.diskStorage`

```js
const storage = multer.diskStorage({
  destination(req, file, cb) {
    cb(null, 'uploads/images');   // å­˜æ”¾å›¾ç‰‡çš„æ–‡ä»¶å¤¹
  },
  filename(req, file, cb) {
    const ext = path.extname(file.originalname); // åŸå§‹æ‰©å±•å
    const newName = Date.now() + '-' + Math.round(Math.random() * 1E9) + ext;
    cb(null, newName); // è‡ªå®šä¹‰æ–‡ä»¶å
  }
});

const uploadImg = multer({ storage });
```

---

# 2) åˆ›å»ºå›¾ç‰‡ä¸Šä¼ æ¥å£

```js
app.post('/upload/image', uploadImg.single('image'), (req, res) => {
  const filePath = '/uploads/images/' + req.file.filename;

  res.json({
    code: 200,
    url: filePath,
    message: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ'
  });
});
```

---

# â­ 3) Express é™æ€èµ„æºæš´éœ²ï¼ˆå‰ç«¯æ‰èƒ½è®¿é—®å›¾ç‰‡ï¼‰

ä¸Šä¼ çš„å›¾ç‰‡éœ€è¦å¯¹å¤–æš´éœ²ï¼š

```js
app.use('/uploads', express.static('uploads'));
```

ç°åœ¨å›¾ç‰‡å¯é€šè¿‡ï¼š

```
http://localhost:3000/uploads/images/xxxxxx.png
```

è¿›è¡Œè®¿é—®å’Œé¢„è§ˆã€‚

---

# ğŸŸ¦ äº”ã€é™åˆ¶åªå…è®¸ä¸Šä¼ å›¾ç‰‡ï¼ˆå¿…å¤‡ï¼‰

`multer` çš„ `fileFilter` å¯ä»¥é™åˆ¶æ–‡ä»¶ç±»å‹ã€‚

```js
const uploadImg = multer({
  storage,
  fileFilter(req, file, cb) {
    const ext = path.extname(file.originalname).toLowerCase();
    const allowExt = ['.jpg', '.jpeg', '.png', '.gif'];

    if (!allowExt.includes(ext)) {
      return cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'));
    }
    cb(null, true);
  }
});
```

---

# ğŸŸ¦ å…­ã€é™åˆ¶ä¸Šä¼ å›¾ç‰‡å¤§å°

`limits` å±æ€§ï¼š

```js
const uploadImg = multer({
  storage,
  limits: {
    fileSize: 2 * 1024 * 1024  // é™åˆ¶ 2MB
  }
});
```

---

# ğŸŸ¦ ä¸ƒã€å¤šæ–‡ä»¶ä¸Šä¼ 

## âœ” ä¸Šä¼ å¤šä¸ªå›¾ç‰‡æ–‡ä»¶

```js
app.post('/upload/images', uploadImg.array('images', 5), (req, res) => {
  const urls = req.files.map(file => '/uploads/images/' + file.filename);
  res.json({ urls });
});
```

å‰ç«¯ï¼š

```html
<input type="file" name="images" multiple>
```

---

# ğŸŸ¦ å…«ã€ç»å…¸é¡¹ç›®å®Œæ•´æ¨¡æ¿ï¼ˆä½ å¯ä»¥ç›´æ¥ç”¨ï¼‰

æŠŠä¸Šé¢å†…å®¹ç»„åˆæˆçœŸæ­£é¡¹ç›®å¯ç”¨æ¨¡æ¿ï¼š

```js
const express = require('express');
const multer = require('multer');
const path = require('path');
const app = express();

// é™æ€èµ„æº
app.use('/uploads', express.static('uploads'));

// å­˜å‚¨é…ç½®
const storage = multer.diskStorage({
  destination(req, file, cb) {
    cb(null, 'uploads/images');
  },
  filename(req, file, cb) {
    const ext = path.extname(file.originalname).toLowerCase();
    const newName = Date.now() + '-' + Math.round(Math.random() * 1E9) + ext;
    cb(null, newName);
  }
});

// ä¸Šä¼ é…ç½®ï¼ˆé™åˆ¶ç±»å‹ & å¤§å°ï¼‰
const uploadImg = multer({
  storage,
  fileFilter(req, file, cb) {
    const ext = path.extname(file.originalname).toLowerCase();
    const allowExt = ['.jpg', '.jpeg', '.png', '.gif'];

    if (!allowExt.includes(ext)) {
      return cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'));
    }
    cb(null, true);
  },
  limits: {
    fileSize: 2 * 1024 * 1024 // 2MB
  }
});

// å›¾ç‰‡ä¸Šä¼ æ¥å£
app.post('/upload/image', uploadImg.single('image'), (req, res) => {
  const url = '/uploads/images/' + req.file.filename;

  res.json({
    code: 200,
    url,
    message: 'ä¸Šä¼ æˆåŠŸ'
  });
});

app.listen(3000, () => console.log("Server is running on port 3000"));
```

---

# ğŸŸ¦ ä¹ã€æœ€åç»™ä½ å¸¸è§åœºæ™¯æ€»ç»“

## âœ” åœºæ™¯ 1ï¼šä¸Šä¼ å¤´åƒ

ä½¿ç”¨ `upload.single('avatar')`
è¿”å›å¤´åƒ URL â†’ å­˜æ•°æ®åº“ã€‚

## âœ” åœºæ™¯ 2ï¼šä¸Šä¼ æ–‡ç« å›¾ç‰‡

ä½¿ç”¨ `upload.single('cover')`
ç›´æ¥è¿”å›å›¾ç‰‡ URL ç»™å‰ç«¯ç¼–è¾‘å™¨ã€‚

## âœ” åœºæ™¯ 3ï¼šä¸Šä¼ å¤šå¼ è½®æ’­å›¾

ä½¿ç”¨ `upload.array('banners', 5)`
è¿”å›ä¸€ä¸ª URL æ•°ç»„ã€‚

## âœ” åœºæ™¯ 4ï¼šé™åˆ¶å¤§å°å’Œæ ¼å¼ï¼ˆéå¸¸å®ç”¨ï¼‰

ä½¿ç”¨ `fileFilter` + `limits.fileSize`

---

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘è¿˜èƒ½ç»™ä½ ï¼š

### ğŸš€ Express + MongoDB ç‰ˆæœ¬çš„

* å›¾ç‰‡ä¸Šä¼ 
* å›¾ç‰‡è·¯å¾„å­˜å…¥æ•°æ®åº“
* ç”¨æˆ·å¤´åƒä¿®æ”¹
* å‰ç«¯ React/Vue çš„ä¸Šä¼ ç»„ä»¶

ä½ éœ€è¦å“ªä¸ªï¼Ÿ
