éå¸¸å¥½ âœ…
ä½ å·²ç»è¿›å…¥çœŸæ­£çš„ **åç«¯å¼€å‘é˜¶æ®µ** äº†ï¼
æˆ‘ä»¬è¦åšçš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„ **Node.js + Express + MySQL ç”¨æˆ·ç³»ç»Ÿ**ï¼ŒåŒ…å«ï¼š

- âœ… ç”¨æˆ·æ³¨å†Œï¼ˆEmail + Passwordï¼‰
- âœ… ç™»å½•ï¼ˆJWT èº«ä»½éªŒè¯ï¼‰
- âœ… ç™»å‡ºï¼ˆToken å¤±æ•ˆï¼‰
- âœ… å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆbcryptï¼‰
- âœ… ä½¿ç”¨ MySQL å­˜å‚¨æ•°æ®

æˆ‘ä¼šå¸¦ä½ ä¸€æ­¥æ­¥ä»é›¶åˆ›å»ºè¿™ä¸ªé¡¹ç›®ï¼Œ**æ¯ä¸€è¡Œä»£ç éƒ½è§£é‡Šæ¸…æ¥š**ï¼Œè®©ä½ å¯ä»¥çœŸæ­£ç†è§£æ•´ä¸ªåç«¯æµç¨‹ã€‚

---

# ğŸ§± ä¸€ã€é¡¹ç›®ç»“æ„ä¸ç¯å¢ƒ

## 1ï¸âƒ£ åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹

```bash
mkdir node-auth-demo
cd node-auth-demo
npm init -y
```

## 2ï¸âƒ£ å®‰è£…ä¾èµ–

```bash
npm install express mysql2 bcrypt jsonwebtoken dotenv
npm install -D nodemon
```

è¯´æ˜ï¼š

| åº“å         | ç”¨é€”                 |
| ------------ | -------------------- |
| express      | Web æ¡†æ¶ï¼ˆå¤„ç†è¯·æ±‚ï¼‰ |
| mysql2       | MySQL é©±åŠ¨           |
| bcrypt       | å¯†ç åŠ å¯†             |
| jsonwebtoken | ç”¨æˆ·ç™»å½•ä»¤ç‰Œï¼ˆJWTï¼‰  |
| dotenv       | è¯»å– `.env` ç¯å¢ƒå˜é‡ |
| nodemon      | å¼€å‘æ—¶è‡ªåŠ¨é‡å¯       |

---

# ğŸ“ äºŒã€é¡¹ç›®ç»“æ„

```
node-auth-demo/
â”‚
â”œâ”€ .env                 # ç¯å¢ƒå˜é‡
â”œâ”€ package.json
â”œâ”€ server.js            # å…¥å£æ–‡ä»¶
â”œâ”€ db.js                # æ•°æ®åº“è¿æ¥
â””â”€ routes/
   â””â”€ auth.js           # ç™»å½•/æ³¨å†Œè·¯ç”±
```

---

# âš™ï¸ ä¸‰ã€é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ`.env`ï¼‰

æ–°å»º `.env` æ–‡ä»¶ï¼š

```env
PORT=3000
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
DB_NAME=node_auth_db
JWT_SECRET=super_secret_key_123
```

---

# ğŸ—ƒï¸ å››ã€åˆ›å»ºæ•°æ®åº“ï¼ˆMySQLï¼‰

æ‰“å¼€ä½ çš„ MySQL å‘½ä»¤è¡Œæˆ–å·¥å…·ï¼ˆå¦‚ Navicat / DBeaverï¼‰ï¼Œæ‰§è¡Œï¼š

```sql
CREATE DATABASE node_auth_db;

USE node_auth_db;

CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

# ğŸ§© äº”ã€æ•°æ®åº“è¿æ¥ï¼ˆdb.jsï¼‰

```js
// db.js
import mysql from "mysql2/promise";
import dotenv from "dotenv";
dotenv.config();

const pool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
});

export default pool;
```

è§£é‡Šï¼š

- `createPool` åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œæ¯”å•ä¸€è¿æ¥æ›´é«˜æ•ˆã€‚
- `async/await` è°ƒç”¨æ—¶è‡ªåŠ¨å¤ç”¨è¿æ¥ã€‚

---

# ğŸšª å…­ã€åˆ›å»ºæœåŠ¡å™¨å…¥å£ï¼ˆserver.jsï¼‰

```js
// server.js
import express from "express";
import dotenv from "dotenv";
import authRoutes from "./routes/auth.js";

dotenv.config();

const app = express();
app.use(express.json()); // è§£æ JSON è¯·æ±‚ä½“

// è·¯ç”±æ³¨å†Œ
app.use("/api/auth", authRoutes);

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`âœ… Server running on port ${PORT}`));
```

---

# ğŸ”‘ ä¸ƒã€å®ç°ç”¨æˆ·è®¤è¯é€»è¾‘ï¼ˆroutes/auth.jsï¼‰

```js
// routes/auth.js
import express from "express";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";
import pool from "../db.js";
import dotenv from "dotenv";

dotenv.config();
const router = express.Router();

// æ³¨å†Œ
router.post("/register", async (req, res) => {
  try {
    const { email, password } = req.body;

    // 1. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
    const [rows] = await pool.query("SELECT * FROM users WHERE email = ?", [
      email,
    ]);
    if (rows.length > 0) {
      return res.status(400).json({ message: "Email å·²æ³¨å†Œ" });
    }

    // 2. åŠ å¯†å¯†ç 
    const hashedPassword = await bcrypt.hash(password, 10);

    // 3. å†™å…¥æ•°æ®åº“
    await pool.query("INSERT INTO users (email, password) VALUES (?, ?)", [
      email,
      hashedPassword,
    ]);

    res.status(201).json({ message: "æ³¨å†ŒæˆåŠŸ" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "æœåŠ¡å™¨é”™è¯¯" });
  }
});

// ç™»å½•
router.post("/login", async (req, res) => {
  try {
    const { email, password } = req.body;

    // 1. æŸ¥æ‰¾ç”¨æˆ·
    const [rows] = await pool.query("SELECT * FROM users WHERE email = ?", [
      email,
    ]);
    if (rows.length === 0) {
      return res.status(400).json({ message: "ç”¨æˆ·ä¸å­˜åœ¨" });
    }

    const user = rows[0];

    // 2. éªŒè¯å¯†ç 
    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      return res.status(400).json({ message: "å¯†ç é”™è¯¯" });
    }

    // 3. ç”Ÿæˆ JWT Token
    const token = jwt.sign(
      { id: user.id, email: user.email },
      process.env.JWT_SECRET,
      {
        expiresIn: "2h",
      }
    );

    res.json({ message: "ç™»å½•æˆåŠŸ", token });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "æœåŠ¡å™¨é”™è¯¯" });
  }
});

// é€€å‡ºï¼ˆè®© Token å¤±æ•ˆï¼‰
router.post("/logout", (req, res) => {
  // çœŸå®é¡¹ç›®ä¸­å¯ä½¿ç”¨ Redis å­˜é»‘åå• Token
  res.json({ message: "é€€å‡ºæˆåŠŸï¼ˆå®¢æˆ·ç«¯åˆ é™¤ Tokenï¼‰" });
});

export default router;
```

---

# ğŸ§  å…«ã€è¿è¡Œé¡¹ç›®

å¯åŠ¨é¡¹ç›®ï¼š

```bash
npm run dev
```

æˆ–ï¼ˆå¦‚æœæ²¡å®šä¹‰ scriptï¼‰ï¼š

```bash
npx nodemon server.js
```

ç»ˆç«¯æç¤ºï¼š

```
âœ… Server running on port 3000
```

---

# ğŸ’¬ ä¹ã€æµ‹è¯•æ¥å£ï¼ˆç”¨ Postman æˆ– curlï¼‰

### 1ï¸âƒ£ æ³¨å†Œç”¨æˆ·

```
POST http://localhost:3000/api/auth/register
```

Bodyï¼ˆJSONï¼‰ï¼š

```json
{
  "email": "test@example.com",
  "password": "123456"
}
```

âœ… è¿”å›ï¼š

```json
{
  "message": "æ³¨å†ŒæˆåŠŸ"
}
```

### 2ï¸âƒ£ ç™»å½•

```
POST http://localhost:3000/api/auth/login
```

Bodyï¼š

```json
{
  "email": "test@example.com",
  "password": "123456"
}
```

âœ… è¿”å›ï¼š

```json
{
  "message": "ç™»å½•æˆåŠŸ",
  "token": "eyJhbGciOiJIUzI1NiIsInR5..."
}
```

### 3ï¸âƒ£ ç™»å‡º

```
POST http://localhost:3000/api/auth/logout
```

è¿”å›ï¼š

```json
{
  "message": "é€€å‡ºæˆåŠŸï¼ˆå®¢æˆ·ç«¯åˆ é™¤ Tokenï¼‰"
}
```

---

# ğŸ§¾ åã€JWT éªŒè¯ä¸­é—´ä»¶ï¼ˆä¿æŠ¤è·¯ç”±ï¼‰

æˆ‘ä»¬æ¥åŠ ä¸ªéªŒè¯ç™»å½•çš„è·¯ç”±ï¼Œä¾‹å¦‚ `/profile`ï¼š

æ–°å»º `middlewares/authMiddleware.js`

```js
import jwt from "jsonwebtoken";
import dotenv from "dotenv";
dotenv.config();

export const verifyToken = (req, res, next) => {
  const token = req.headers["authorization"];
  if (!token) return res.status(401).json({ message: "æœªæä¾› Token" });

  try {
    const decoded = jwt.verify(token.split(" ")[1], process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (err) {
    return res.status(403).json({ message: "Token æ— æ•ˆæˆ–è¿‡æœŸ" });
  }
};
```

åœ¨ `auth.js` é‡ŒåŠ ä¸€æ¡å—ä¿æŠ¤è·¯ç”±ï¼š

```js
import { verifyToken } from "../middlewares/authMiddleware.js";

router.get("/profile", verifyToken, async (req, res) => {
  const [rows] = await pool.query(
    "SELECT id, email, created_at FROM users WHERE id = ?",
    [req.user.id]
  );
  res.json(rows[0]);
});
```

æµ‹è¯•ï¼š

```
GET http://localhost:3000/api/auth/profile
```

Header é‡ŒåŠ ï¼š

```
Authorization: Bearer <ä½ çš„token>
```

âœ… è¿”å›ç”¨æˆ·ä¿¡æ¯ã€‚

---

# ğŸ§© åä¸€ã€å¯é€‰ï¼šåœ¨ package.json æ·»åŠ è„šæœ¬

```json
"scripts": {
  "dev": "nodemon server.js",
  "start": "node server.js"
}
```

ç„¶åï¼š

```bash
npm run dev
```

---

# ğŸ§  åäºŒã€æ€»ç»“

ä½ ç°åœ¨æŒæ¡äº†ï¼š
âœ… Node.js åŸºç¡€
âœ… Express æ¡†æ¶
âœ… MySQL æ•°æ®è¿æ¥
âœ… å¯†ç åŠ å¯†ä¸æ ¡éªŒ
âœ… JWT ç™»å½•è®¤è¯
âœ… Token éªŒè¯ä¸­é—´ä»¶

---

æ˜¯å¦å¸Œæœ›æˆ‘ **ä¸‹ä¸€æ­¥å¸®ä½ æ‰©å±•è¿™ä¸ªé¡¹ç›®**ï¼ˆä»»é€‰ä¸€ä¸ªæ–¹å‘æˆ‘ç»§ç»­å†™ç»™ä½ ï¼‰ğŸ‘‡
1ï¸âƒ£ åŠ ä¸Š **é‚®ç®±æ ¼å¼éªŒè¯ + å¯†ç å¤æ‚åº¦éªŒè¯ + é‡å¤æ³¨å†Œæ£€æŸ¥**
2ï¸âƒ£ å®ç° **åˆ·æ–° Tokenï¼ˆRefresh Tokenï¼‰æœºåˆ¶**
3ï¸âƒ£ æ·»åŠ  **ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ¥å£ï¼ˆä¿®æ”¹å¯†ç  / é‚®ç®±ï¼‰**
4ï¸âƒ£ ä½¿ç”¨ **Sequelize ORM** æ¥ä»£æ›¿åŸå§‹ SQLï¼Œè®©ä»£ç æ›´ç®€æ´

ä½ æƒ³æˆ‘å¸®ä½ å†™å“ªä¸€ä¸ªï¼Ÿ
